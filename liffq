<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>LIFF è‡ªåŠ©æŸ¥è©¢</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f8f9fa; }
    h2 { margin-top: 30px; }
    input, button { padding: 6px 12px; font-size: 16px; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; background: #fff; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    th { background: #f1f1f1; }
    .total { margin-top: 15px; font-weight: bold; }
    .chart-container { margin-top: 20px; }
  </style>
</head>
<body>
  <h1>ğŸ“Š è‡ªåŠ©æŸ¥è©¢</h1>

  <input type="text" id="queryInput" placeholder="è¼¸å…¥æŒ‡ä»¤ (ä¾‹ï¼šæœ¬æœˆã€æœ¬æœˆåˆ†é¡)">
  <button onclick="sendQuery()">æŸ¥è©¢</button>
  <button onclick="sendQuick('æœ¬æœˆ')">ğŸ“… æœ¬æœˆ</button>
  <button onclick="sendQuick('æœ¬æœˆåˆ†é¡')">ğŸ“‚ æœ¬æœˆåˆ†é¡</button>

  <div id="queryResult"></div>

  <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbwMijNx7xvxY7lRGQgQBRZiBl7QCWopdM33hGcFLQUHnYiLDxMGruSUw3AVBWoCcXiTBA/exec"; // TODO: æ›æˆä½ çš„ GAS éƒ¨ç½²ç¶²å€

    function sendQuick(cmd) {
      document.getElementById("queryInput").value = cmd;
      sendQuery();
    }

    async function sendQuery() {
      const command = document.getElementById("queryInput").value.trim();
      if (!command) return alert("è«‹è¼¸å…¥æŸ¥è©¢æŒ‡ä»¤");

      const resp = await fetch(GAS_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ type: "query", command })
      });
      const json = await resp.json();
      console.log("æŸ¥è©¢çµæœ", json);

      let html = `<h2>ğŸ” æŸ¥è©¢çµæœï¼š${command}</h2>`;

      // === æœ¬æœˆ ===
      if (command === "æœ¬æœˆ" && json.rows && json.rows.length > 0) {
        html += `<table>
          <tr>
            <th>æ—¥æœŸ</th>
            <th>åº—å®¶</th>
            <th>é‡‘é¡</th>
            <th>ä»˜æ¬¾</th>
            <th>åˆ†é¡</th>
            <th>å‚™è¨»</th>
          </tr>`;
        json.rows.forEach(r => {
          let dateStr = "";
          if (r[4]) {
            const d = new Date(r[4]);
            dateStr = d.toLocaleDateString("zh-TW", {
              timeZone: "Asia/Taipei",
              year: "numeric",
              month: "2-digit",
              day: "2-digit"
            });
          }
          html += `<tr>
            <td>${dateStr}</td>
            <td>${r[10] || ""}</td>
            <td>${Number(r[5]).toLocaleString()}</td>
            <td>${r[7] || ""}</td>
            <td>${r[6] || ""}</td>
            <td>${r[8] || ""}</td>
          </tr>`;
        });
        html += `</table>`;
        html += `<div class="total">ğŸ“Œ æœ¬æœˆç¸½é¡ï¼š${Number(json.total).toLocaleString()} å…ƒï¼ˆå…± ${Number(json.count).toLocaleString()} ç­†ï¼‰</div>`;
        html += `<div class="chart-container"><canvas id="monthChart"></canvas></div>`;
      }

      // === æœ¬æœˆåˆ†é¡ ===
      if (command === "æœ¬æœˆåˆ†é¡" && json.categories) {
        // è¡¨æ ¼
        html += `<table>
          <tr><th>åˆ†é¡</th><th>é‡‘é¡</th></tr>`;
        Object.keys(json.categories).forEach(cat => {
          html += `<tr><td>${cat}</td><td>${json.categories[cat].toLocaleString()}</td></tr>`;
        });
        html += `</table>`;
        html += `<div class="total">ğŸ“Œ æœ¬æœˆç¸½é¡ï¼š${Number(json.total).toLocaleString()} å…ƒ</div>`;
        html += `<div class="chart-container"><canvas id="categoryChart"></canvas></div>`;
      }

      document.getElementById("queryResult").innerHTML = html;

      // === ç•«åœ– ===
      if (command === "æœ¬æœˆ" && json.rows) {
        const daily = {};
        json.rows.forEach(r => {
          if (r[4]) {
            const d = new Date(r[4]);
            const dateStr = d.toLocaleDateString("zh-TW", {
              timeZone: "Asia/Taipei",
              month: "2-digit",
              day: "2-digit"
            });
            daily[dateStr] = (daily[dateStr] || 0) + Number(r[5]);
          }
        });
        const ctx = document.getElementById('monthChart').getContext('2d');
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: Object.keys(daily),
            datasets: [{
              label: 'æ¯æ—¥æ”¯å‡º',
              data: Object.values(daily),
              backgroundColor: '#36A2EB'
            }]
          },
          options: {
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } }
          }
        });
      }

      if (command === "æœ¬æœˆåˆ†é¡" && json.categories) {
        const ctx = document.getElementById('categoryChart').getContext('2d');
        new Chart(ctx, {
          type: 'pie',
          data: {
            labels: Object.keys(json.categories),
            datasets: [{
              data: Object.values(json.categories),
              backgroundColor: ['#FF6384','#36A2EB','#FFCE56','#4CAF50','#FF9800','#9C27B0','#00BCD4']
            }]
          }
        });
      }
    }
  </script>
</body>
</html>

